## プロジェクト概要

このプロジェクトは、ユーザーが指定した主要都市に基づいて天気情報をLINEを通じて通知するLINE BOTの開発を目的としています。気象庁（JMA）が提供する天気予報データを活用し、シンプルで効率的な天気情報通知システムを構築します。

## 機能概要

- 天気通知機能: ユーザーが選択した主要都市の天気情報をLINEで通知する。
- ユーザー認証: LINEアカウント情報を利用したユーザー認証。
- 通知スケジュール管理: ユーザーごとに通知の時刻と都市を設定し、指定した時間に天気情報を送信。 
- 都市選択機能: ユーザーが初回設定時に主要都市を選択し、後から変更可能。

## 技術スタック

1. アプリケーションアーキテクチャ

- コンテナ技術: Kubernetesを利用してコンテナを管理。HelmやKustomizeを使用してKubernetesのマニフェストを効率的に管理し、後々の運用も見据えた設定を行う。
- API連携: 以下のAPIを活用して天気情報を取得する。
- 天気予報: 気象庁（JMA）API (https://www.jma.go.jp/bosai/forecast/data/forecast/{location_id}.json)

2. システムインフラ

- CI/CD:
    - CI: GitHub Actionsにより自動テストとデプロイを効率化。
    - CD: ArgoCDを採用し、Kubernetes上での継続的デリバリーを実現。
- デプロイ: 
    - オンプレを想定する。
- IaC: 
    - Terraformを利用してインフラをコードで管理。

3. 認証とメッセージ送信

- ユーザー認証: 
    - LINE MessagingAPIのユーザーIDを使用。
- メッセージ通知: 
    - LINE Messaging APIを使って天気情報を通知。

4. データ管理

- データベース:
    - キャッシュ: Redisを利用。
    - RDBMS: PostgreSQLを使用。

## 詳細設計

1. 天気通知機能

機能概要

ユーザーが選択した主要都市に基づき、天気情報をLINEで通知する機能です。基本的には雨の時のみ通知します。

実装のポイント

データ取得

- 気象庁APIの活用:
- 主要都市のlocation_idを事前に確認し、定期的に天気情報を取得します。
- APIのレスポンスデータを解析し、必要な情報（天気、気温、湿度、風速、降水確率など）を抽出します。
- APIの効率的な利用:
- CronJobを使用して1時間おきに全主要都市の天気情報を取得し、キャッシュ（例：Redis）に保存します。
- キャッシュを利用することで、ユーザーリクエスト時にリアルタイムでAPIを呼び出す必要を減らし、システムの効率を向上させます。

メッセージフォーマット

- LINE Messaging APIの利用:
- リッチメニューやテンプレートメッセージを活用して、視覚的にわかりやすい天気情報を提供します。
- メッセージの内容やレイアウトをユーザーの設定に応じてカスタマイズ可能にします。

レート制限対策

- APIのレート制限:
- 気象庁APIの利用頻度をCronJobで制御し、定期的にデータを取得することでレート制限を管理します。

スケーリングとパフォーマンス

- 非同期処理の導入:
- 通知の送信を非同期に処理することで、システムの応答性を向上させます。

実装における課題

- APIのレート制限:
- 気象庁APIの利用制限に注意し、必要に応じて取得頻度を調整。
- データの正確性と更新頻度:
- 天気情報の更新頻度に応じて、適切なデータ取得タイミングを設定します。

2. ユーザー認証

機能概要

LINEアカウント情報を利用してユーザー認証を行い、個別の設定や通知を管理します。

実装のポイント

認証フロー

- LINE Loginの利用:
- ユーザーがLINEアカウントを友だち追加する際に取得できるユーザーIDを使用します。

アクセストークンの管理

- アクセストークンの安全な保存:
- LINEから取得したアクセストークンを安全に保存・管理します。
- トークンの有効期限を監視し、必要に応じてリフレッシュトークンを使用して更新します。

ユーザーデータの管理

- データベース設計:
- ユーザー情報（LINEのユーザーID、アクセストークン、設定情報など）をPostgreSQLに保存します。
- セキュリティを考慮し、個人情報は暗号化して保存します。
- プライバシーとセキュリティ:
- データベースへのアクセス制御や暗号化を徹底します。

実装における課題

- 認証の信頼性:
- 認証フロー中のエラーハンドリングを適切に行い、ユーザーにわかりやすいエラーメッセージを提供します。
- スケーラビリティ:
- 多数のユーザーが同時に認証を行った場合でも、システムが安定して動作するように設計します。

3. 通知スケジュール管理

機能概要

ユーザーごとに通知の時刻と都市を設定し、指定した時間に天気情報を送信します。

実装のポイント

スケジューリングシステム

- ジョブスケジューラーの選定:
- CronJob: 主要都市の天気情報を定期的に取得し、キャッシュを更新します。
- 通常のJob: ユーザーごとの通知ジョブを管理し、指定された時間に天気情報を送信します。
- スケジュールの動的管理:
- ユーザーが通知時間や都市を変更した際に、スケジュールを動的に更新できる仕組みを構築します。

データ管理

- 通知設定の保存:
- ユーザーごとの通知時刻、都市の設定をデータベースに保存します。
- スケジュールジョブをトリガーするための情報も含めます。

タイムゾーンの考慮
- 基本的に日本国内を対象とします。
- すべてのユーザーのタイムゾーンを日本標準時（JST）に統一します。

実装における課題

- 時間の正確性:
	- サーバーのタイムゾーンとユーザーのタイムゾーンの違いを適切に管理し、通知が正確な時間に送信されるようにします。
- スケーラビリティとパフォーマンス:
	- 大規模なユーザー数に対応するため、スケジューリングシステムのパフォーマンスを最適化します。

4. 主要都市の天気情報管理

機能概要

主要都市の天気情報を事前に取得し、ユーザーが選択できるようにします。

実装のポイント

主要都市の選定と管理

- 主要都市リストの作成:
	- `https://www.jma.go.jp/bosai/common/const/area.json`をもとにIDを割り当てた。
- データの取得と更新:
	- CronJobを使用して、1時間おきに主要都市の天気情報を気象庁APIから取得し、キャッシュに保存します。

データ取得の自動化

- CronJobの設定:
	- Kubernetes CronJobを設定し、定期的に天気情報を取得するジョブを実行します。
- キャッシュの活用:
	- 取得した天気情報をRedisにキャッシュし、ユーザーリクエスト時に迅速に提供できるようにします。

ユーザーインターフェースの調整

- 都市選択のUI:
	- 初回設定時にユーザーに主要都市を選択させるインターフェースを提供します。

実装における課題

- データの一貫性:
	- 天気情報の取得タイミングとユーザーへの通知タイミングの整合性を保つ必要があります。
- エラーハンドリング:
	- 天気情報の取得に失敗した場合の対応策（リトライ、通知しないなど）を実装します。

5. キャッシュ戦略

キャッシュのタイミング

- CronJobによる定期取得:
- Kubernetes CronJobを使用して、主要都市の天気情報を1時間おきに取得し、Redisにキャッシュします。

キャッシュの有効期限

- 天気情報の有効期限を1時間に設定し、CronJobで定期的に更新します。これにより、データの鮮度を維持しつつ、キャッシュの有効期限を適切に管理します。


6. データベース設計

テーブル構造

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    line_user_id VARCHAR(255) UNIQUE NOT NULL,
    selected_city_id VARCHAR(10) REFERENCES area_class20(id),
    notify_time TIME NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

データベース設計のポイント

- ユーザー情報: users テーブルにLINEユーザーID、アクセストークン、選択した都市のlocation_idを保存。
- 都市情報: cities テーブルに主要都市のlocation_idと名前、地域を保存。
- 通知設定: notification_settings テーブルにユーザーごとの通知時刻、形式、タイムゾーンを保存。
- 通知履歴: notification_history テーブルに過去の通知データを保存し、履歴管理を実現。
