# 実装計画

このドキュメントは README に記載された内容と現在のコードを比較し、アプリケーションとして期待される挙動を満たすために必要な実装項目を整理したものです。

## 1. LINE Messaging API 連携
現在の `ProcessWeatherForUser` は取得した天気情報をログに出力するのみです。ユーザーへ通知する仕組みを追加します。

### 実装ステップ
1. `go.mod` に `github.com/line/line-bot-sdk-go/v7` を追加する。
2. LINE メッセージ送信用のサービス層 (`internal/service/line`) を作成し、アクセストークンとチャネルシークレットを環境変数から読み込む。
3. `weatherUsecase` にこのサービスを組み込み、`notify` フラグが立った場合にプッシュ通知を送信する。
4. Helm や Compose の環境変数設定にも LINE 用の値を追記する。
5. LINE クライアントをモック化したユニットテストを追加する。

## 2. LINE Login 認証フロー
ユーザー ID のみを保存しており、認証やアクセストークンの管理が行われていません。

### 実装ステップ
1. LINE Login の OAuth2 フローを実装し、認可コード取得後のコールバックエンドポイントを追加する。
2. アクセストークンとリフレッシュトークンを保存するためのテーブルを作成し、マイグレーションを追加する。
3. トークンの有効期限を管理し、必要に応じてリフレッシュトークンで更新する処理を実装する。
4. 認証が必要な API にミドルウェアを追加し、トークン検証を行う。
5. 認証フロー全体を自動テストでカバーする。

## 3. 自動スケジューリング
現在は `/api/process_weather` を手動で実行する必要があります。

### 実装ステップ
1. 全都市の天気データを取得し Redis に保存する CronJob を Kubernetes マニフェストおよび Helm テンプレートに追加する。実行間隔は 1 時間を想定。
2. ユーザーの通知時間帯に合わせて `ProcessWeatherForUsersInTimeRange` を起動する CronJob も追加する。
3. ローカル環境では `cron` ライブラリなどを用いて同等の処理を行えるようにし、`docker-compose` からも起動できるようにする。
4. ジョブ実行ログを集約し、失敗時に確認できるよう設定する。

## 4. Redis キャッシュ
天気 API を毎回呼び出しており、キャッシュが存在しません。

### 実装ステップ
1. `github.com/go-redis/redis/v8` を導入し、`compose.yml` と Helm の `values.yaml` に Redis サービスを追加する。
2. `weatherUsecase` 内で天気データ取得前に Redis を確認し、存在しない場合のみ JMA API を呼び出してキャッシュする処理を追加する。
3. キャッシュキーは都市 ID と日付の組み合わせとし、有効期限を 1 時間に設定する。
4. `miniredis` を用いたユニットテストでキャッシュ処理を検証する。

## 5. チャットボット UI
都市や通知時間をチャットで設定するワークフローが未実装です。

### 実装ステップ
1. LINE の Webhook エンドポイントを実装し、ユーザーからのメッセージイベントを受信する。
2. 都市一覧や時間帯を提示するメニューを Flex Message などで作成し、ユーザーが選択できるようにする。
3. 選択結果を `user` テーブルに保存し、既存の CRUD API からも更新できるよう統合する。
4. 対話フローのテストを追加する。

## 6. CI/CD と ArgoCD
GitHub Actions では Go テストのみ実行しています。

### 実装ステップ
1. `build/kubernetes` に ArgoCD 用の Application マニフェストを追加する。
2. GitHub Actions を拡張し、Docker イメージのビルドとプッシュ、そして ArgoCD の Sync を自動で行うようにする。
3. Helm チャートを更新し、新しく追加する CronJob などのリソースを含める。

## 7. その他の整備
不要な設定や不足しているテンプレートの修正を行います。

### 実装ステップ
1. `compose.yml` の `build: ./server` をリポジトリルートに修正する。
2. Helm チャートに CronJob テンプレートを追加し、`values.yaml` から設定できるようにする。
3. 使われなくなった環境変数を整理し、ドキュメントも更新する。

---

以上の項目を実施することで、README に記載された機能要件を満たすアプリケーションへ近づきます。
